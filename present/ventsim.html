<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced VentSim: Physiology Engine (Non-Linear)</title>
    <style>
        /* --- Styles (Dark Mode) - ‡∏Ñ‡∏á‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° --- */
        body { font-family: 'Sukhumvit Set', 'Kanit', sans-serif; line-height: 1.7; color: #eeeeee; margin: 0; padding: 20px; background-color: #222831; }
        .container { max-width: 1000px; margin: auto; background: #393e46; padding: 30px 40px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); }
        
        h1 { color: #74d0f7; border-bottom: 4px solid #74d0f7; padding-bottom: 12px; margin-bottom: 30px; text-align: center; font-size: 2em; font-weight: 800; }
        h2 { color: #a4c9ff; border-left: 6px solid #4a90e2; padding-left: 15px; margin-top: 40px; margin-bottom: 20px; font-size: 1.5em; font-weight: 700; background-color: #4a5462; padding-top: 5px; padding-bottom: 5px; border-radius: 4px; }
        h3 { color: #4ade80; margin-top: 25px; margin-bottom: 12px; font-size: 1.25em; font-weight: 700; }
        
        .equation { 
            background-color: #2e343d; border: 1px solid #4a90e2; border-radius: 8px; padding: 20px; margin: 20px 0 0; 
            overflow-x: auto; font-family: 'Consolas', 'Courier New', monospace; font-size: 1.2em; font-weight: 700; text-align: center;
        }
        .equation strong { color: #74d0f7; }
        .info-box { background-color: #4a4f56; border: 1px solid #757b85; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 0.95em; }
        .info-box p, .info-box ul { color: #dddddd; margin: 5px 0; }
        .highlight { color: #ff7f7f; font-weight: 700; }
        .icon { font-size: 1.2em; margin-right: 8px; }

        /* Color Coding Boxes */
        .elastic-box { background-color: #424f46; border-color: #4ade80; }
        .resistive-box { background-color: #554446; border-color: #ff7f7f; }
        .gas-exchange-box { background-color: #40485a; border-color: #74d0f7; }
        .setting-box { background-color: #444a56; border-color: #a4c9ff; }
        .graph-box { background-color: #424653; border-color: #f7b44e; }

        hr { border: 0; height: 1px; background-color: #555555; margin: 30px 0; }

        /* Simulation UI */
        .sim-container { background-color: #1e2126; border: 1px solid #555; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; justify-content: center; }
        .btn { 
            background-color: #393e46; color: white; border: 1px solid #4a90e2; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; font-family: inherit; font-size: 0.9em;
        }
        .btn:hover { background-color: #4a90e2; }
        .btn.active { background-color: #4a90e2; font-weight: bold; box-shadow: 0 0 8px rgba(74, 144, 226, 0.5); }
        .btn.control-btn { border-color: #f7b44e; color: #f7b44e; }
        .btn.control-btn:hover { background-color: #f7b44e; color: #222; }
        .btn.control-btn.paused { background-color: #f7b44e; color: #222; }
        
        canvas { background-color: #000; border: 1px solid #333; width: 100%; display: block; margin-bottom: 5px; border-radius: 4px; }
        
        /* Grid ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Monitor */
        .monitor-values { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        @media (min-width: 600px) { .monitor-values { grid-template-columns: repeat(6, 1fr); } }

        .monitor-card { background: #222; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #444; }
        .monitor-label { font-size: 0.75em; color: #aaa; display: block; margin-bottom: 2px; }
        .monitor-val { font-size: 1.2em; font-weight: bold; color: #fff; font-family: 'Consolas', monospace; }
        
        .text-blue { color: #4a90e2; } .text-green { color: #4ade80; } .text-red { color: #ff7f7f; } .text-yellow { color: #f7b44e; } .text-purple { color: #c678dd; }

        .phys-desc-dynamic { font-size: 0.9em; text-align: center; color: #aaa; margin-top: 10px; padding: 10px; background: #2c313a; border-radius: 4px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Advanced Respiratory Physics Engine (Non-Linear)</h1>
        <p>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏£‡∏µ‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á: Hysteresis, Turbulence, ‡πÅ‡∏•‡∏∞ Volume-Dependent Resistance</p>

        <div class="sim-container">
            <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #444; padding-bottom:10px;">
                <span class="icon">üíª</span> Live Simulation
            </h3>
            
            <div class="controls">
                <button class="btn control-btn" id="btn-toggle" onclick="toggleSim()">‚è∏ Pause</button>
                <div style="width: 1px; height: 30px; background: #444; margin: 0 10px;"></div>
                <button class="btn active" onclick="setPreset('NORMAL')">Normal Lung</button>
                <button class="btn" onclick="setPreset('ARDS')">ARDS (Stiff)</button>
                <button class="btn" onclick="setPreset('COPD')">COPD (Obstructive)</button>
                <button class="btn" onclick="setPreset('FIBROSIS')">Fibrosis (Restrictive)</button>
            </div>

            <div class="monitor-values">
                <div class="monitor-card"><span class="monitor-label">Ppeak</span><span class="monitor-val text-yellow" id="val-ppeak">--</span></div>
                <div class="monitor-card"><span class="monitor-label">Vte (ml)</span><span class="monitor-val text-blue" id="val-vte">--</span></div>
                <div class="monitor-card"><span class="monitor-label">MV (L)</span><span class="monitor-val text-green" id="val-mv">--</span></div>
                <div class="monitor-card"><span class="monitor-label">C_dyn</span><span class="monitor-val text-purple" id="val-cdyn">--</span></div>
                <div class="monitor-card"><span class="monitor-label">R_aw (Dyn)</span><span class="monitor-val text-red" id="val-raw">--</span></div>
                <div class="monitor-card"><span class="monitor-label">RR Set</span><span class="monitor-val text-blue">15</span></div>
            </div>

            <canvas id="waveforms" height="320"></canvas>
            <div class="phys-desc-dynamic" id="phys-desc">
                </div>
            <div style="text-align: right; font-size: 0.8em; color: #777; margin-top: 5px;">*Showing 30s window (Non-Linear Physics)</div>
        </div>

        <hr>

        <h2><span class="icon">‚öôÔ∏è</span> 1. ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
        <p>Engine ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö <strong>Non-Linear</strong> ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤ Resistance (R) ‡πÅ‡∏•‡∏∞ Compliance (C) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏õ‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á:</p>

        <div class="equation">
            P<sub>alv</sub> = P<sub>elastic</sub>(V) &nbsp;&nbsp;+&nbsp;&nbsp; P<sub>resistive</sub>(F, V) &nbsp;&nbsp;+&nbsp;&nbsp; PEEP
        </div>

        <div class="info-box elastic-box">
            <h4 style="color: #4ade80; margin-top:0;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (Advanced Mechanics)</h4>
            <ul>
                <li><strong>Overdistension & Hysteresis:</strong> ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ "‡πÄ‡∏õ‡∏¥‡∏î" ‡∏õ‡∏≠‡∏î (‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤) ‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ "‡∏Ñ‡∏á‡∏™‡∏†‡∏≤‡∏û" ‡∏õ‡∏≠‡∏î (‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å) ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡∏õ‡∏≠‡∏î‡∏à‡∏∞‡πÅ‡∏Ç‡πá‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏° (Vmax)</li>
                <li><strong>Dynamic Resistance:</strong> ‡∏¢‡∏¥‡πà‡∏á Flow ‡πÄ‡∏£‡πá‡∏ß ‡∏Ñ‡πà‡∏≤ R ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á (Turbulence) ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏≠‡∏î‡πÅ‡∏ü‡∏ö ‡∏ó‡πà‡∏≠‡∏•‡∏°‡∏à‡∏∞‡∏ï‡∏µ‡∏ö‡∏•‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ R ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (Tethering effect)</li>
            </ul>
        </div>

        <hr>
        
        <h2><span class="icon">üß™</span> 3. ‡∏û‡∏¢‡∏≤‡∏ò‡∏¥‡∏™‡∏†‡∏≤‡∏û (Pathology Presets)</h2>
        <p>‡πÅ‡∏ï‡πà‡∏•‡∏∞ Preset ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ R, C, Hysteresis, ‡πÅ‡∏•‡∏∞ Turbulence ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏£‡∏µ‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö Patient Mechanics ‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
        <div class="info-box setting-box">
            <h4 style="color: #a4c9ff; font-weight: bold;">Presets ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏•‡∏±‡∏Å:</h4>
            <ul>
                <li><strong>NORMAL:</strong> ‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á. Time Constant ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏°‡∏µ Hysteresis ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</li>
                <li><strong>ARDS (Restrictive):</strong> C ‡∏ï‡πà‡∏≥ (‡∏õ‡∏≠‡∏î‡πÅ‡∏Ç‡πá‡∏á), Hysteresis ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (Recruitment/Derecruitment) <strong class="highlight">(‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠ Hypoxemia ‡πÅ‡∏•‡∏∞ VILI)</strong></li>
                <li><strong>COPD (Obstructive):</strong> R ‡∏™‡∏π‡∏á (‡∏´‡∏•‡∏≠‡∏î‡∏•‡∏°‡∏ï‡∏µ‡∏ö) ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å (Dynamic Compression) <strong class="highlight">(‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠ Air Trapping/AutoPEEP)</strong></li>
                <li><strong>FIBROSIS (Restrictive):</strong> ‡∏õ‡∏≠‡∏î‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ô‡πâ‡∏≠‡∏¢ (Low Vmax) ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏≤‡∏ü‡∏ä‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏ô‡∏¥‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Å‡∏ß‡πà‡∏≤ ARDS ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Hysteresis ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤</li>
            </ul>
        </div>

        <hr>

        <h2><span class="icon">üéõÔ∏è</span> 4. ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏µ‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</h2>
        <p>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏°‡∏µ‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏õ‡∏≠‡∏î (VILI) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏ß‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î:</p>

        <div class="info-box setting-box">
            <ul>
                <li><strong>Vt (Tidal Volume):</strong> ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏≠‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á. ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î V<sub>t</sub> (‡πÄ‡∏ä‡πà‡∏ô 4-8 ml/kg PBW) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Driving Pressure ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á <strong class="highlight">Volutrauma</strong></li>
                <li><strong>Pinsp / PS (Pressure):</strong> ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î. ‡∏´‡∏≤‡∏Å‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ P<sub>plat</sub> ‡πÄ‡∏Å‡∏¥‡∏ô 30 cmH<sub>2</sub>O ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠ <strong class="highlight">Barotrauma</strong> ‡πÅ‡∏•‡∏∞ Overdistension</li>
                <li><strong>RR ‡πÅ‡∏•‡∏∞ Ti (Inspiratory Time):</strong> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î T<sub>e</sub> (Expiratory Time). ‡∏´‡∏≤‡∏Å T<sub>e</sub> ‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ R ‡∏™‡∏π‡∏á (Time Constant ‡∏¢‡∏≤‡∏ß) ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏†‡∏≤‡∏ß‡∏∞ <strong class="highlight">Air Trapping</strong> ‡πÅ‡∏•‡∏∞ AutoPEEP</li>
                <li><strong>PEEP:</strong> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô. PEEP ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ñ‡∏∏‡∏á‡∏•‡∏°‡∏¢‡∏∏‡∏ö‡∏ï‡∏±‡∏ß (Recruitment) ‡πÅ‡∏•‡∏∞‡∏•‡∏î **Shunt** ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° SpO<sub>2</sub> ‡πÅ‡∏ï‡πà PEEP ‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏≠‡∏≤‡∏à‡∏•‡∏î Cardiac Output</li>
                <li><strong>FiO<sub>2</sub>:</strong> **‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å** ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏ß‡∏∞ Hypoxemia (SpO<sub>2</sub> ‡∏ï‡πà‡∏≥) ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å **Shunt** ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</li>
            </ul>
        </div>

        <hr>

        <h2><span class="icon">üìà</span> 5. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ Monitor</h2>
        <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ Monitor ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Mechanics ‡πÅ‡∏•‡∏∞ Gas Exchange ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ö‡∏ö Real-time:</p>

        <h3>5.1 Monitor Values (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</h3>
        <div class="info-box gas-exchange-box">
            <ul>
                <li><strong>Pplat (P<sub>plateau</sub>):</strong> ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Inspiratory Hold ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (Stress) ‡∏Ç‡∏≠‡∏á‡∏õ‡∏≠‡∏î ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ **Pplat &lt; 30** cmH<sub>2</sub>O</li>
                <li><strong>Driving Pressure (P<sub>plat</sub> - PEEP):</strong> ‡∏ï‡∏±‡∏ß‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î/‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏î (Strain) ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏õ‡∏≠‡∏î ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ **Driving P &lt; 15** cmH<sub>2</sub>O</li>
                <li><strong>PEEPi (AutoPEEP):</strong> ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ñ‡∏∏‡∏á‡∏•‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î ‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏†‡∏≤‡∏ß‡∏∞ <strong class="highlight">Air Trapping</strong></li>
                <li><strong>Cstat (Static Compliance):</strong> Vt / Driving P ‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏≠‡∏î (Stiffness)</li>
                <li><strong>SpO<sub>2</sub> (Estimated):</strong> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å **Shunt** ‡πÅ‡∏•‡∏∞ **FiO<sub>2</sub>**</li>
                <li><strong>EtCO<sub>2</sub> (Estimated):</strong> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å MV ‡πÅ‡∏•‡∏∞ **Deadspace**</li>
                <li><strong>R_aw (Dynamic):</strong> (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô Engine ‡πÉ‡∏´‡∏°‡πà) ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏• ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏î‡∏•‡∏°‡πÅ‡∏ö‡∏ö Real-time</li>
            </ul>
        </div>
        
        <hr>

        <h2><span class="icon">üìâ</span> 6. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏û‡∏¢‡∏≤‡∏ò‡∏¥‡∏™‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≤‡∏á‡πÜ</h2>
        <p>‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏õ‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô Resistance ‡∏´‡∏£‡∏∑‡∏≠ Compliance ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏à (‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö):</p>

        <h3><span class="icon">üß±</span> 6.1 ARDS / Fibrosis (Restrictive: Low C)</h3>
        <div class="info-box graph-box">
            <p><strong>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</strong> ‡∏õ‡∏≠‡∏î‡πÅ‡∏Ç‡πá‡∏á (Low C) ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</p>
            <ul>
                <li><strong>P-V Loop:</strong> **‡∏ä‡∏±‡∏ô‡∏°‡∏≤‡∏Å** (Steep Slope) ‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ñ‡∏∂‡∏á **C<sub>stat</sub> ‡∏ï‡πà‡∏≥**</li>
                <li><strong>P-T Graph:</strong> P<sub>peak</sub> ‡πÅ‡∏•‡∏∞ P<sub>plat</sub> **‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å** ‡πÅ‡∏ï‡πà‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Elasticity)</li>
            </ul>
        </div>

        <h3><span class="icon">üï≥Ô∏è</span> 6.2 COPD / Asthma (Obstructive: High R)</h3>
        <div class="info-box graph-box">
            <p><strong>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</strong> ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏µ‡∏ö (High R) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏ä‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å</p>
            <ul>
                <li><strong>P-T Graph:</strong> P<sub>peak</sub> **‡∏™‡∏π‡∏á‡πÇ‡∏î‡∏î**, ‡πÅ‡∏ï‡πà P<sub>plat</sub> ‡πÑ‡∏°‡πà‡∏™‡∏π‡∏á (P<sub>peak</sub> - P<sub>plat</sub> ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å ‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ R ‡∏™‡∏π‡∏á)</li>
                <li><strong>F-T Graph:</strong> Expiratory Flow **‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏®‡∏π‡∏ô‡∏¢‡πå** ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Air Trapping)</li>
            </ul>
        </div>

        <h3><span class="icon">‚öñÔ∏è</span> 6.3 Dual-Lung / Fibrosis Pathology</h3>
        <div class="info-box graph-box">
            <p><strong>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</strong> ‡∏û‡∏¢‡∏≤‡∏ò‡∏¥‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏õ‡∏≠‡∏î‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î (Restrictive)</p>
            <ul>
                <li><strong>P-V Loop:</strong> ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏à‡∏∞‡πÅ‡∏ö‡∏ô‡∏£‡∏≤‡∏ö (Flat) ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á Compliance ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥</li>
                <li><strong>Monitor:</strong> ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Fibrosis ‡∏Ç‡∏≠‡∏á Engine ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô Vmax ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å (‡∏õ‡∏≠‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</li>
            </ul>
        </div>
    </div>

<script>
    // --- 1. ADVANCED CONFIGURATION (New Engine) ---
    const PRESETS = {
        'NORMAL': { 
            name: "Normal Physiological Lung",
            cBase: 60,      // Basic Compliance (ml/cmH2O)
            hysteresis: 2,  // Pressure difference required for recruitment
            vMax: 3.0,      // Capacity (L)
            rBase: 5,       // Airway Resistance
            rFlowFactor: 0.5, 
            rVolDependence: 1.0,
            desc: "<b>Normal:</b> Resistance ‡πÅ‡∏•‡∏∞ Compliance ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à Hysteresis ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥ (Surfactant ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)"
        },
        'ARDS': { 
            name: "Severe ARDS",
            cBase: 25,      // Very Stiff
            hysteresis: 8,  // High Hysteresis
            vMax: 1.0,      // Baby Lung
            rBase: 8,       
            rFlowFactor: 0.5,
            rVolDependence: 0.5, 
            desc: "<b>ARDS:</b> <span class='highlight'>Low Compliance</span> ‡∏õ‡∏≠‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏°‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á <span class='highlight'>High Hysteresis</span> ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å (Recruitment)"
        },
        'COPD': { 
            name: "Severe COPD",
            cBase: 80,      // High Static Compliance (Emphysema)
            hysteresis: 3,  
            vMax: 3.5,      // Hyperinflated
            rBase: 15,      // High Base Resistance
            rFlowFactor: 2.5, 
            rVolDependence: 4.0, // Critical: R increases massively at low volumes
            desc: "<b>COPD:</b> <span class='highlight'>High Resistance</span> ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å (Dynamic Compression) ‡∏Ñ‡πà‡∏≤ R ‡∏à‡∏∞‡∏û‡∏∏‡πà‡∏á‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Flow ‡∏™‡∏π‡∏á‡∏´‡∏£‡∏∑‡∏≠ Volume ‡∏ï‡πà‡∏≥"
        },
        'FIBROSIS': {
             name: "Pulmonary Fibrosis",
             cBase: 20,
             hysteresis: 3,
             vMax: 0.8, // Restrictive
             rBase: 6, 
             rFlowFactor: 0.5,
             rVolDependence: 1.5,
             desc: "<b>Fibrosis:</b> <span class='highlight'>Restrictive</span> ‡∏õ‡∏≠‡∏î‡∏´‡∏î‡∏£‡∏±‡∏î‡∏ï‡∏±‡∏ß ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î (Low Vmax) ‡∏Å‡∏£‡∏≤‡∏ü‡∏ä‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏ô‡∏¥‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Å‡∏ß‡πà‡∏≤ ARDS ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Hysteresis ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤"
        }
    };

    const SETTINGS = {
        PEEP: 5,
        Pinsp: 15, // Pressure Control Level (Above PEEP)
        RR: 15,
        Ti: 1.0
    };

    // Simulation State
    let isRunning = true;
    let currentPreset = PRESETS['NORMAL'];
    let t = 0;
    let cycleT = 0;
    let phase = 'EXP';
    
    // Physics State
    let state = {
        paw: 5,     // Airway Pressure
        palv: 5,    // Alveolar Pressure
        vol: 0,     // Volume above FRC (L)
        flow: 0,    // Flow (L/s)
        lastRaw: 0,
        lastComp: 0
    };

    // Data History
    const MAX_POINTS = 1800; // 30s @ 60fps
    let history = { p: [], f: [], v: [] };

    // --- 2. PHYSICS ENGINE (Non-Linear Logic) ---
    function updatePhysics() {
        const dt = 0.0167; // 1/60 s
        t += dt;
        cycleT += dt;

        // 2.1 Cycle Logic (PCV Simulation)
        const cycleDur = 60 / SETTINGS.RR;
        if (phase === 'INS' && cycleT >= SETTINGS.Ti) {
            phase = 'EXP'; cycleT = 0;
        } else if (phase === 'EXP' && cycleT >= (cycleDur - SETTINGS.Ti)) {
            phase = 'INS'; cycleT = 0;
        }

        // 2.2 Ventilator Output (Target Paw)
        let targetPaw = SETTINGS.PEEP;
        if (phase === 'INS') targetPaw = SETTINGS.PEEP + SETTINGS.Pinsp;
        
        // Valve lag smoothing
        state.paw += (targetPaw - state.paw) * 0.2;

        // --- 2.3 ADVANCED LUNG MECHANICS ---

        // A. RESISTANCE (Non-Linear)
        let volForRes = Math.max(0.1, state.vol + 0.5); // Avoid div by zero, assume FRC ~ 0.5 offset
        let volFactor = Math.pow(1.0 / volForRes, currentPreset.rVolDependence);
        let flowFactor = 1 + (currentPreset.rFlowFactor * Math.abs(state.flow));
        
        let currentR = currentPreset.rBase * flowFactor * volFactor;
        currentR = Math.min(currentR, 200); 

        // B. COMPLIANCE & ELASTIC RECOIL (Non-Linear + Hysteresis)
        let relativeVol = state.vol / currentPreset.vMax;
        if(relativeVol > 0.95) relativeVol = 0.95; // Limit
        
        // Overdistension term
        let overdistension = Math.pow(relativeVol, 4) * 20; 
        
        // Hysteresis
        let hysteresisForce = 0;
        if (state.flow > 0) { // Insp
            hysteresisForce = currentPreset.hysteresis * (1 - relativeVol); 
        } else { // Exp
            hysteresisForce = -currentPreset.hysteresis * 0.2; 
        }

        // Total Elastic Recoil Pressure
        let Pel = (state.vol * 1000 / currentPreset.cBase) + overdistension + hysteresisForce;

        // C. EQUATION OF MOTION: Flow = (Paw - Palv) / R
        let drivingP = state.paw - Pel; 
        state.flow = drivingP / currentR;

        // Update Volume
        state.vol += state.flow * dt;
        if(state.vol < 0) state.vol = 0; 

        // --- 2.4 DATA LOGGING ---
        state.lastRaw = currentR; 
        
        // Calculate Dynamic Compliance (approx for cycle)
        if (phase === 'INS' && Math.abs(state.flow) < 0.05) {
             let dP = state.paw - SETTINGS.PEEP;
             if(dP > 0) state.lastComp = (state.vol * 1000) / dP;
        }

        history.p.push(state.paw);
        history.f.push(state.flow * 60); // L/min
        history.v.push(state.vol * 1000); // ml

        if (history.p.length > MAX_POINTS) {
            history.p.shift(); history.f.shift(); history.v.shift();
        }

        // Update UI every 5 frames
        if (Math.floor(t * 60) % 5 === 0) updateMonitors(Pel);
    }

    function updateMonitors(Pel) {
        document.getElementById('val-ppeak').innerText = Math.round(state.paw);
        document.getElementById('val-vte').innerText = Math.round(state.vol * 1000);
        document.getElementById('val-mv').innerText = ((state.vol * 1000 * SETTINGS.RR) / 1000).toFixed(1);
        
        document.getElementById('val-cdyn').innerText = state.lastComp > 0 ? Math.round(state.lastComp) : "--";
        document.getElementById('val-raw').innerText = Math.round(state.lastRaw);
    }

    // --- 3. RENDERING (Canvas) ---
    function draw() {
        if (isRunning) updatePhysics();
        
        const canvas = document.getElementById('waveforms');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height;

        ctx.clearRect(0, 0, w, h);
        
        // Draw Grids
        const zoneH = h / 3;
        ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
        ctx.beginPath(); 
        ctx.moveTo(0, zoneH); ctx.lineTo(w, zoneH); 
        ctx.moveTo(0, 2*zoneH); ctx.lineTo(w, 2*zoneH);
        ctx.stroke();

        // Draw Waves
        drawWave(ctx, history.p, 0, zoneH, '#f7b44e', 0, 40, "Paw (cmH2O)");
        drawWave(ctx, history.f, zoneH, zoneH, '#4ade80', -60, 60, "Flow (L/min)");
        drawWave(ctx, history.v, 2*zoneH, zoneH, '#4a90e2', 0, 800, "Volume (ml)");

        requestAnimationFrame(draw);
    }

    function drawWave(ctx, data, yOffset, h, color, min, max, label) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        
        const range = max - min;
        
        // Draw Label & Max/Min
        ctx.fillStyle = color;
        ctx.font = "12px sans-serif";
        ctx.fillText(label, 5, yOffset + 15);
        ctx.textAlign = "right";
        ctx.fillText(max, ctx.canvas.width - 5, yOffset + 15);
        ctx.fillText(min, ctx.canvas.width - 5, yOffset + h - 5);
        ctx.textAlign = "left";

        for (let i = 0; i < data.length; i++) {
            let x = (i / MAX_POINTS) * ctx.canvas.width;
            let val = data[i];
            let norm = (val - min) / range;
            let y = yOffset + h - (norm * h); 
            if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    // --- 4. CONTROLS ---
    function setPreset(key) {
        currentPreset = PRESETS[key];
        document.querySelectorAll('.btn:not(.control-btn)').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('phys-desc').innerHTML = currentPreset.desc;
        
        // Reset State
        state.vol = 0; state.flow = 0; state.paw = SETTINGS.PEEP;
        history = { p: [], f: [], v: [] };
    }

    function toggleSim() {
        isRunning = !isRunning;
        const btn = document.getElementById('btn-toggle');
        if (isRunning) {
            btn.innerText = "‚è∏ Pause";
            btn.classList.remove('paused');
        } else {
            btn.innerText = "‚ñ∂ Play";
            btn.classList.add('paused');
        }
    }

    // Init
    setPreset('NORMAL'); 
    draw();

</script>
</body>
</html>
